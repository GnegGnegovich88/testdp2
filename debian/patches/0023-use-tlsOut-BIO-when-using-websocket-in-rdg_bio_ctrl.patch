From c1387856692d28ded58f66bff2e294edf0f9c0ac Mon Sep 17 00:00:00 2001
From: akarl <mike@mwsys.mine.bz>
Date: Fri, 5 Mar 2021 18:19:06 +0100
Subject: [PATCH 23/36] use tlsOut BIO when using websocket in rdg_bio_ctrl

(cherry picked from commit 0e19c443e41cdc031a38a6ea24298972420af778)
---
 libfreerdp/core/gateway/rdg.c | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/libfreerdp/core/gateway/rdg.c b/libfreerdp/core/gateway/rdg.c
index 4ac98b1c9..ff2d06aa5 100644
--- a/libfreerdp/core/gateway/rdg.c
+++ b/libfreerdp/core/gateway/rdg.c
@@ -1537,7 +1537,7 @@ DWORD rdg_get_event_handles(rdpRdg* rdg, HANDLE* events, DWORD count)
 			return 0;
 	}
 
-	if (rdg->tlsIn && rdg->tlsIn->bio)
+	if (!rdg->transferEncoding.isWebsocketTransport && rdg->tlsIn && rdg->tlsIn->bio)
 	{
 		if (events && (nCount < count))
 		{
@@ -2403,7 +2403,8 @@ static long rdg_bio_ctrl(BIO* bio, int cmd, long arg1, void* arg2)
 	if (cmd == BIO_CTRL_FLUSH)
 	{
 		(void)BIO_flush(tlsOut->bio);
-		(void)BIO_flush(tlsIn->bio);
+		if (!rdg->transferEncoding.isWebsocketTransport)
+			(void)BIO_flush(tlsIn->bio);
 		status = 1;
 	}
 	else if (cmd == BIO_C_SET_NONBLOCK)
@@ -2418,6 +2419,10 @@ static long rdg_bio_ctrl(BIO* bio, int cmd, long arg1, void* arg2)
 	else if (cmd == BIO_C_WRITE_BLOCKED)
 	{
 		BIO* bio = tlsIn->bio;
+
+		if (rdg->transferEncoding.isWebsocketTransport)
+			bio = tlsOut->bio;
+
 		status = BIO_write_blocked(bio);
 	}
 	else if (cmd == BIO_C_WAIT_READ)
@@ -2437,6 +2442,9 @@ static long rdg_bio_ctrl(BIO* bio, int cmd, long arg1, void* arg2)
 		int timeout = (int)arg1;
 		BIO* bio = tlsIn->bio;
 
+		if (rdg->transferEncoding.isWebsocketTransport)
+			bio = tlsOut->bio;
+
 		if (BIO_write_blocked(bio))
 			status = BIO_wait_write(bio, timeout);
 		else if (BIO_read_blocked(bio))
-- 
2.30.2

